version: '3.8'

services:
  # Main application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatsapp-business-platform
    ports:
      - "${SERVER_PORT:-8080}:8080"
      - "${MCP_PORT:-3000}:3000"
      - "${METRICS_PORT:-9090}:9090"
    environment:
      - SERVER_PORT=${SERVER_PORT:-8080}
      - SERVER_HOST=0.0.0.0
      - ENV=${ENV:-development}
      - DB_DRIVER=${DB_DRIVER:-postgres}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - DB_NAME=${DB_NAME:-whatsapp_platform}
      - DB_SSL_MODE=disable
      - DB_SQLITE_PATH=${DB_SQLITE_PATH:-/root/storage/whatsapp_platform.db}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_WEBHOOK_VERIFY_TOKEN=${WHATSAPP_WEBHOOK_VERIFY_TOKEN}
      - WHATSAPP_API_VERSION=${WHATSAPP_API_VERSION:-v18.0}
      - STORAGE_TYPE=${STORAGE_TYPE:-minio}
      - S3_BUCKET=${S3_BUCKET:-whatsapp-business-media}
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-minioadmin}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-minioadmin}
      - MCP_ENABLED=${MCP_ENABLED:-true}
      - MCP_PORT=${MCP_PORT:-3000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - METRICS_ENABLED=${METRICS_ENABLED:-true}
      - METRICS_PORT=${METRICS_PORT:-9090}
    volumes:
      - ./storage:/root/storage
    depends_on:
      - minio
      # postgres is optional - uncomment if using postgres driver
      # - postgres
    restart: unless-stopped
    networks:
      - whatsapp-platform-network

  # PostgreSQL Database (Optional - for production)
  # Enable with: docker-compose --profile postgres up
  # Or set DB_DRIVER=postgres in your .env file
  postgres:
    image: postgres:15-alpine
    container_name: whatsapp-platform-postgres
    environment:
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-postgres}
      - POSTGRES_DB=${DB_NAME:-whatsapp_platform}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - whatsapp-platform-network
    profiles:
      - postgres
      - production

  # Minio for S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: whatsapp-platform-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${S3_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${S3_SECRET_KEY:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    restart: unless-stopped
    networks:
      - whatsapp-platform-network

  # Prometheus (optional - for metrics)
  prometheus:
    image: prom/prometheus:latest
    container_name: whatsapp-platform-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9091:9090"
    volumes:
      - ./deployments/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    restart: unless-stopped
    networks:
      - whatsapp-platform-network
    profiles:
      - monitoring

volumes:
  postgres-data:
  minio-data:
  prometheus-data:

networks:
  whatsapp-platform-network:
    driver: bridge
